{% extends "menu_base.html" %}
{% load webmgr_tags %}

{% block title %}Create a new Virtual Machine{% endblock %}

{% block head %}
    <link rel="stylesheet" type="text/css"
            href="{{MEDIA_URL}}/css/virtual_machine_create.css"/>
    <style>
        /* single option dropdown label style */  
        .singleOptionDropdownLabel{
            color:gray;
            font-weight:bold;
            cursor:default;
        }
    </style>
    <script src="{{MEDIA_URL}}/js/jquery.js"></script>
    <script type="text/javascript">
        
        // -------
        // "main"
        // -------
        $(document).ready(function() {
            /* run when document is fully loaded */
           
            // init the live-form updater
            var frmUpdater = new formUpdater(
                    '{% url instance-create-cluster-choices %}',
                    '{% url instance-create-cluster-options %}',
                    '{% url instance-create-cluster-defaults %}');
            frmUpdater.init();
 
            // init the help tips for the individ. form objects
            initHelpTips();
        });

        // ----------
        // help tips
        // ----------
        function initHelpTips(){
            /* initialize the help tips for each item */
            $('#virtualmachineform input, #virtualmachineform select')
                .live('focus', function(){
                    name = this.name;
                    label = $(this).prev('label').html()
                    $content = $('#help-'+name);
                    
                    if($content.length != 0){
                        $('#help')
                            .show();
                        $('#help div')
                            .empty()
                            .html($content.html());
                        $('#help h3')
                            .empty()
                            .html(label);
                    }
                });
        }

        // ------------------
        // dropdown to label
        // ------------------
        function dropdownToLabel(dropdown, ignoreOpt){
            /*
            Conditionally convert dropdowns to labels, i.e. if the specified 
            dropdown has only one option, select that option, hide the
            dropdown, and replace it with a label of that option. Note that 
            'dropdown' must be a jQuery object.
                
            If ignoreOpt is supplied, options with called ignoreOpt will 
            be ignored and treated as if they don't exist. This is useful if 
            the dropdown has "blank" options such as "-----" or 
            "- choose one -" etc.

            Note that it might be nice to make this into a jQuery plugin
            eventually.
            */

            var optElems = dropdown.find('option');
            var opts = [];
            var PROCESSED_OP_ID = "singleOptionDropdownLabel";
            var processedOpElems =
                    dropdown.siblings().filter('.'+PROCESSED_OP_ID);

            // create a new list of options sans any "blanks", if specified
            if(ignoreOpt != undefined){
                optElems.each(function(i, opt){
                    if($(opt).text() != ignoreOpt)
                        opts.push(opt);
                });

            // otherwise just use the options as is
            } else {
                opts = optElems;
            }

            // if there's only one option, (not including "blank" options if
            // specified,) select it, hide the dropdown, and replace it with 
            // a label
            if(opts.length == 1){
                $(opts).attr('selected', 'selected');
                dropdown.hide();
                dropdown.change();
                
                // if no processed options (label versions of the single-option
                // dropdown) make the label
                if(processedOpElems.length == 0){
                    dropdown.parent().append(
                        "<div class='"+PROCESSED_OP_ID+" disabledText'>" + 
                            $(opts).text() + 
                        "</div>");
                }

            // otherwise, replace the processed option, if it exists, with a
            // label
            } else {
                dropdown.show();
                processedOpElems.remove();
            }
        }

        // -------------------
        // live form updating
        // -------------------
        function formUpdater(url_choices, url_options, url_defaults){
            /* class for live form updating */
            
            // -----------
            // class data
            // -----------
            var cluster =               $("#id_cluster");
            var owner =                 $("#id_owner");
            var snode =                 $("#id_snode").parent();
            var pnode =                 $("#id_pnode").parent();
            var niclink =               $("#id_niclink").parent();
            var disk_template =         $("#id_disk_template");
            var nicmode =               $("#id_nicmode");
            var curSelection =          $("#id_snode option:selected").index();
            var iallocator =            $("#id_iallocator");
            var iallocator_hostname =   $("#id_iallocator_hostname");
            var bootOrder =             $("#id_bootorder");
            var imagePath =             $("#id_imagepath");
            var using_str =             ' Using: ';
            var blankOptStr =           '---------';

            // ------------
            // init stuffs
            // ------------
            this.init = function(){
                /* initialize the live form updator */

                // disable the iallocator stuff by default
                if(!iallocator_hostname.attr('value'))
                    iallocator.attr('readonly', 'readonly');
                else
                    iallocator.after("<span>" +
                            using_str+iallocator_hostname.val() +
                            "</span>");
                _iallocatorDisable();
            
                // hide CD-ROM Image Path stuffs by default
                _imagePathHide();

                // setup form element change hooks
                _initChangeHooks();

                // fire off some initial changes
                iallocator.change();
                disk_template.change();
                bootOrder.change();
                
                // process the owner dropdown, i.e., if it only has a single
                // option, select it, and make the dropdown read-only
                dropdownToLabel(owner, blankOptStr);
            }
            
            function _initChangeHooks(){
                /* setup change hooks for the form elements */

                // boot device change
                bootOrder.change(function(){
                    /* 
                    Only show image path stuffs if CD-ROM is selected in
                    the boot order dropdown.
                    */
                    var dropdown = $(this);
                    var id = $(this).children("option:selected").val();
                    if(id == 'cdrom'){
                        _imagePathShow();
                    } else {
                        _imagePathHide();
                    }
                });

                // iallocator change
                iallocator.change(function() {
                    if(!iallocator.attr('readonly')) {
                        if(iallocator.is(':checked')) {
                            pnode.hide();
                            snode.hide();
                        } else {
                            pnode.show();
                            disk_template.change();
                        }
                    } else {
                        if(!iallocator.is(':checked')){
                            pnode.show();
                            disk_template.change();
                        }
                    }
                });

                // disk_template change
                disk_template.change(function() {
                    if(!iallocator.is(':checked') || 
                            iallocator.attr('readonly')) {
                        if( disk_template.val() == 'drbd'){
                            snode.show();
                        } else {
                            snode.hide();
                        }
                    }
                });

                // owner change
                owner.change(function() {
                    var dropdown = $(this);
                    var id = $(this).children("option:selected").val();

                    if(id != '') {
                        // JSON update the cluster when the owner changes
                        $.getJSON(url_choices, {'clusteruser_id':id}, 
                                function(data){
                            cluster.children().not(':first').remove();
                            $.each(data, function(i, item) {
                                child = $("<option> </option>");
                                child.attr('value', item[0]);
                                child.attr('text', item[1]);
                                cluster.append(child);
                            });

                            // process dropdown if it's a singleton
                            dropdownToLabel(cluster, blankOptStr);

                            // trigger a change in the cluster
                            cluster.change();
                        });
                    }
                });

                // cluster change
                cluster.change(function() {
                    var pnode       = $("#id_pnode");
                    var snode       = $("#id_snode");
                    var oslist      = $("#id_os");
                    var dropdown    = $(this);
                    var id = $(this).children("option:selected").val();
                    
                    if( id != '' ) {
                        // JSON update oslist, pnode, and snode when cluster 
                        // changes
                        $.getJSON(url_options, {'cluster_id':id},
                                function(data){
                            pnode.children().not(':first').remove();
                            snode.children().not(':first').remove();
                            oslist.children().not(':first').remove();
                            $.each(data, function(i, items) {
                                $.each(items, function(key, value) {
                                    if( i == 'nodes' ) {
                                        child = _newOpt(value, value);
                                        child2 = child.clone();
                                        pnode.append(child);
                                        snode.append(child2);

                                        dropdownToLabel(pnode, blankOptStr);
                                        dropdownToLabel(snode, blankOptStr);
                                    }
                                    else if (i == 'os') {
                                        child = _newOptGroup(value[0], 
                                                value[1]);
                                        oslist.append(child);

                                        dropdownToLabel(oslist,
                                                blankOptStr);
                                    }
                                });
                            });
                        });

                        $.getJSON(url_defaults, {'cluster_id':id}, function(d){
                            /* fill default options */

                            // boot device dropdown
                            if(d['bootorder']) {
                                $("#id_bootorder :selected").removeAttr(
                                        'selected');
                                $("#id_bootorder [value="+d['bootorder']
                                        +"]").attr('selected','selected');
                            }
                            
                            // hypervisors
                            if(d['hypervisors']) {
                                //list - do nothing for now.
                            }

                            // iallocator checkbox
                            if(d['iallocator'] != "" && 
                                    d['iallocator'] != undefined){
                                if(!iallocator_hostname.attr('value')) {
                                    iallocator_hostname.attr('value',
                                            d['iallocator']);
                                    if(iallocator.siblings("span").length 
                                            == 0){
                                        iallocator.after("<span>" + using_str +
                                                d['iallocator'] + 
                                                "</span>");
                                    }
                                }
                                // Check iallocator checkbox
                                iallocator.show();
                                iallocator.siblings().show();
                                iallocator.removeAttr('disabled');
                                iallocator.removeAttr('readonly');
                                iallocator.attr('checked', 'true');
                                iallocator.change();
                            } else {
                                _iallocatorDisable();
                            }

                            // kernel path text box
                            if(d['kernelpath']){
                                $("#id_kernelpath").val(d['kernelpath']);
                            } else {
                                $("#id_kernelpath").val('');
                            }

                            // nic mode dropdown
                            if(d['nicmode']) {
                                $("#id_nicmode :selected").removeAttr(
                                        'selected');
                                $("#id_nicmode [value="+d['nicmode']+"]").attr(
                                        'selected','selected');
                            } else { 
                                $("#id_nicmode :first-child").attr('selected', 
                                        'selected');
                            }

                            // nic link text box
                            if(d['niclink']){
                                $("#id_niclink").val(d['niclink']);
                            }
                            
                            // nic type dropdown
                            if(d['nictype']) {
                                $("#id_nictype :selected").removeAttr(
                                        'selected');
                                $("#id_nictype [value="+d['nictype']+"]").attr(
                                        'selected','selected');
                            }

                            // memory text box
                            if(d['ram']){
                                $("#id_ram").val(d['ram']);
                            }

                            // disk type dropdown
                            if(d['disktype']){
                                 $("#id_disk_type").val(d['disktype']);
                            }
                            
                            // root path text box
                            if(d['rootpath']){
                                $("#id_rootpath").val(d['rootpath']);
                            } else {
                                $("#id_rootpath").val('/');
                            }
                            
                            // enable serial console checkbox
                            if(d['serialconsole']){
                                $("#id_serialconsole").attr('checked', true);
                            }
                            
                            // virtual CPUs text box
                            if(d['vcpus']){
                                $("#id_vcpus").val(d['vcpus']);
                            }
                            
                            // image path text box
                            if(d['imagepath']){
                                $("#id_imagepath").val(imagepath);
                            }
                        });
                    }
                });
            }

            // ----------------
            // private helpers
            // ----------------
            function _imagePathHide(){
                imagePath.hide();
                imagePath.siblings().hide();
            }

            function _imagePathShow(){
                imagePath.show();
                imagePath.siblings().show();
            }

            function _iallocatorDisable(){
                /* Disable and hide all of the iallocator stuffs */
                iallocator.hide();
                iallocator_hostname.removeAttr('value')
                iallocator.siblings().hide();
                iallocator.attr('disabled', 'disabled');
                iallocator.removeAttr('checked');
                iallocator.change();
            }

            function _newOpt(value, text) {
                /* Create new option items for select field */
                o = $("<option></option>");
                o.attr("value", value);
                o.attr("text", text);
                return o;
            }

            function _newOptGroup(value, options) {
                /* Create new option group for select field */
                group = $("<optgroup></optgroup>");
                group.attr("label", value);
                $.each(options, function(i, option) {
                    group.append(_newOpt(option[0], option[1]));
                });
                return group;
            }
        }
    </script>
{% endblock %}

{% block content %}
<div id="virtualmachineform">
    <form method="post">
        <fieldset>
            <h1><span class="breadcrumb">Virtual Machine</span> : Create</h1>
            {% vmfield form.owner %}
            {% vmfield form.cluster %}
            {% vmfield form.hostname %}
            {% vmfield form.start %}
            {% vmfield form.name_check %}
            {% vmfield form.iallocator %}
            {% vmfield form.iallocator_hostname.as_hidden %}
            {% vmfield form.disk_template %}
            {% vmfield form.pnode %}
            {% vmfield form.snode %}
            {% vmfield form.os %}
        </fieldset>
        <fieldset>
            <legend>General Parameters</legend>
            {% vmfield form.vcpus %}
            {% vmfield form.ram %}
            {% vmfield form.disk_size %}
            {% vmfield form.disk_type %}
            {% vmfield form.nicmode %}
            {% vmfield form.niclink %}
            {% vmfield form.nictype %}
        </fieldset>
        <fieldset>
            <legend>Hypervisor Parameters</legend>
            {% vmfield form.kernelpath %}
            {% vmfield form.rootpath %}
            {% vmfield form.serialconsole %}
            {% vmfield form.bootorder %}
            {% vmfield form.imagepath %}
        </fieldset>
        <input class="submit" type="submit" value="Create">
    </form>
    
    
</div>

    <div id="help">
        <h3></h3>
        <div></div>
    </div>

    <div id="help-contents">
        {# performatted help content that will be copied into the help div #}
        <div id="help-owner">
            <p>
            The owner indicates who this virtual machine belongs to. Resources
            used by the virtual machine will be deducted from the owner's
            quota.
            </p>
            <p>
            An owner may be a user or a group.  If you are a member of a group
            you may create a virtual machine on behalf of that group.
            </p>
            <p>
            If your user does not directly have access/permission to a cluster,
            it will not have permission to own a virtual machine directly.
            </p>
        </div>
        <div id="help-cluster">
            <p>
            Which ganeti cluster to deploy the new virtual machine on.
            </p>
        </div>
        <div id="help-hostname">
            Fully qualified domain name <i>(<b>FQDN</b>)</i> to assign to this
            virtual machine. <i>(e.g. hostname.example.org)</i>
        </div>


        <div id="help-start">
            <p>
            Uncheck this if you don't want the instance to automatically start
            after creation. If you do so, you can start it manually on the
            virtual machine detail page.
            </p>
        </div>
        <div id="help-name_check">
            <p>
            Check the virtual machine DNS name via the resolver <i>(e.g. in DNS
            or /etc/hosts, depending on your setup)</i>. Since the name check
            is used to compute the IP address this also enables/disables IP
            checks <i>(e.g.  if the IP is pingable)</i>.
            </p>
            <p>
            This is useful for setups that deploy virtual machines using
            dynamic DNS and thus the name is not resolvable yet.
            </p>
            <p>
            <b>Use with caution!</b> If left unchecked you may run into name/ip
            collisions.
            </p>
        </div>
        <div id="help-iallocator">
            <p>
            Automatically select primary and secondary node to allocate disks
            on.
            </p>
            <p>
            When selected it will use the cluster default 
            <a href="http://docs.ganeti.org/ganeti/current/html/iallocator.html">
            iallocator</a> (if set by the cluster). The iallocator being used
            will be displayed after the checkbox.
            </p>
        </div>
        <div id="help-disk_template">
            <p>
            Disk layout template for the virtual machine on the cluster node.
            </p>
            <p>The available choices are:</p>
            <ul>
                <li>
                    <b>plain</b> - Disk devices will be logical volumes <i>
                    (e.g.  LVM)</i>
                </li>
                <li>
                    <b>drbd</b> - Disk devices will be 
                    <a href="http://www.drbd.org/">DRBD</a> (version 8.x) on 
                    top of LVM volumes
                </li>
                <li>
                    <b>file</b> - Disk devices will be regular files
                    <i>(e.g.  qcow2)</i>
                </li>
                <li>
                    <b>diskless</b> - This creates a virtual machine with no
                    disks. Its useful for testing only (or other special
                    cases).
                </li>
            </ul>
            <p>
                If drbd is selected, then a primary and secondary node will
                need to be chosen unless automatic allocation has been 
                selection. DRBD will allow the virtual machine to use live 
                migration and failover in case one of the nodes goes offline.
            </p>
        </div>
        <div id="help-pnode">
            The primary node to use for the virtual machine (in case automatic
            allocation is not used).
        </div>
        <div id="help-snode">
            <p>
                The secondary node to use for the virtual machine (in case
                automatic allocation is not used).
            </p>
            <p>
                This is only required when using the drbd disk template.
            </p>
        </div>
        <div id="help-os">
            <p>
                Operating system to install on the virtual machine. Your
                choices are limited to the images configured on the cluster.
            </p>
            <p>
                The text in <b>bold</b> signifies the Ganeti Operating
                System Type which may be called debootstrap, image, or some
                other type. The text that is selectable is the operating system
                (or os-type variant) that the cluster has access to.
            </p>
        </div>

        <div id="help-vcpus">
            <p>Number of virtual cpus to allocate to this virtual machine.<p>
            <p><b><i>This will be deducted from the owner's quota.</i></b></p>
        </div>
        <div id="help-ram">
            <p>
                Amount of ram to allocate to this virtual machine. If no units
                are given, megabytes is assumed.
            </p>
            <p><b><i>This will be deducted from the owner's quota.</i></b></p>
        </div>
        <div id="help-disk_size">
            <p>
                Size of the system disk to allocate to this virtual machine. If
                no units are given, megabytes is assumed.
            </p>
            <p><b><i>This will be deducted from the owner's quota.</i></b></p>
        </div>
        <div id="help-disk_type">
            <p>
                This parameter determines the way the disks are presented to
                the virtual machine. The possible options are:
            </p>
            <ul>
                <li><b>paravirtual</b> - (HVM &amp; KVM)</li>
                <li>
                    <b>ioemu</b> - (default for HVM &amp; KVM) (HVM &amp; KVM)
                </li>
                <li><b>ide</b> - (HVM &amp; KVM)</li>
                <li><b>scsi</b> - (KVM)</li>
                <li><b>sd</b> - (KVM)</li>
                <li><b>mtd</b> - (KVM)</li>
                <li><b>pflash</b> - (KVM)</li>
            </ul>
            <p>Valid for the Xen HVM and KVM hypervisors.</p>
        </div>
        <div id="help-nicmode">
            <p>
                This option specifies how the virtual machine connects to the
                network. More information on this can be found in the <a
                href="http://docs.ganeti.org/ganeti/current/html/install.html#configuring-the-network">
                Ganeti tutorial documentation</a>.
            </p>
            <p>When in doubt, choose <b>bridged</b>.</p>
            <ul>
                <li>
                    <b>bridged</b> - The virtual machine's network interface
                    will be attached to a software bridge running on the node.
                </li>
                <li><b>routed</b> - The virtual machine's network interface
                    will be routed
                </li>
            </ul>
        </div>
        <div id="help-niclink">
            <p>
                In <b>bridged</b> mode, it specifies the bridge interface to
                attach this NIC to on the node <i>(e.g. br0)</i>.
            </p>
            <p>
                In <b>routed</b> mode it's intended to differentiate between 
                different routing tables/virtual machine groups (but the 
                meaning is dependant on the network script, see 
                <a href="http://docs.ganeti.org/ganeti/current/man/gnt-cluster.html">
                gnt-cluster(8)</a> for more details.
            </p>
        </div>
        <div id="help-nictype">
            <p>
                This parameter determines the way the network cards are 
                presented to the virtual machine. The possible options are:
            </p>
            <ul>
                <li><b>rtl8139</b> - (default for Xen HVM) (HVM &amp; KVM)</li>
                <li><b>ne2k_isa</b> - (HVM &amp; KVM)</li>
                <li><b>ne2k_pci</b> - (HVM &amp; KVM)</li>
                <li><b>i82551</b> - (KVM)</li>
                <li><b>i82557b</b> - (KVM)</li>
                <li><b>i82559er</b> - (KVM)</li>
                <li><b>pcnet</b> - (KVM)</li>
                <li><b>e1000</b> - (KVM)</li>
                <li><b>paravirtual</b> - (default for KVM) (KVM &amp; HVM)</li>
            </ul>
            <p>Valid for the Xen PVM and KVM hypervisors.</p>
        </div>

        <div id="help-kernelpath">
            <p>
                This option specifies the path (on the node) to the kernel to 
                boot the virtual machine with. Xen PVM instances always require
                this, while for KVM if this option is empty, it will cause the
                machine to load the kernel from its disks.
            </p>
            <p>Valid for the Xen PVM and KVM hypervisors.</p>
        </div>
        <div id="help-rootpath">
            <p>
                This option specifies the name of the root device. This is 
                always needed for Xen PVM, while for KVM it is only used if the
                kernel_path option is also specified.
            </p>
            <p>Valid for the Xen PVM and KVM hypervisors.</p>
        </div>
        <div id="help-serialconsole">
            <p>
                This boolean option specifies whether to emulate a serial
                console for the instance.
            </p>
            <p>Valid for the KVM hypervisor.</p>
        </div>
        <div id="help-bootorder">
            <p>Value denoting boot order for the virtual machine.</p>
            <ul>
                <li><b>Hard Disk</b> - boot from the first disk device</li>
                <li>
                    <b>CD-ROM</b> - boot from the cdrom (requires CD Image path
                    being set)
                </li>
            </ul>
            <p>Valid for the Xen HVM and KVM hypervisors.</p>
        </div>
        <div id="help-imagepath">
            <p>
               The path to a CDROM image on the node to attach to the virtual
               machine.
            </p>
            <p>Valid for the Xen HVM and KVM hypervisors.</p>
        </div>
    </div>
{% endblock %}
