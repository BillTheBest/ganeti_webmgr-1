{% block head %}

<style>
    td.actions div.delete {
        float:none;
    }
    #content td.actions a, #content td.actions {
        padding:5px 0 0 0;
    }
    #vm-wrapper {
        margin-top: 40px;
    }
</style>

<script type="text/javascript">

    function ajaxTable(url, tableID){
       
        var FETCH_ARGS = {page:1};
        var url = url;
        var tableID = tableID;

        // get this table's ID
        this.getID = function(){
            return '#' + tableID;
        }

        // paginator stuffs
        this.pageUp = function(){
            console.log("Incrementing page...");
            FETCH_ARGS["page"] = FETCH_ARGS["page"] + 1;
        }

        this.pageDown = function(){
            console.log("Decrementing page...");
            FETCH_ARGS["page"] = FETCH_ARGS["page"] - 1;
        }
        this.setPage = function(page){
            console.log("Updating page number to "+page);
            FETCH_ARGS["page"] = page;
        }

        // -----
        // init 
        // -----
        this.init = function(){
            
            console.log("Initializing table '"+this.getID()+"'...");

            /*
            // pagination click handling
            $(tableID + ' .pagination .previous').live('click', function(e){
                e.preventDefault();
                table.pageDown();
                table.update();
            });
           
            $(tableID + ' .pagination .next').data('table', table);
            $(tableID + ' .pagination .next').live('click', function(e){
                var table = $(this).data('table');
                alert("Next link clicked.");
                e.preventDefault();
                table.pageUp();
                table.update();
            });
            */

            $(this.getID() + ' .pagination .page:not(.active)').data('table', this);
            $(this.getID() + ' .pagination .page:not(.active)')
                    .live('click', function(){
                var table = $(this).data('table');
                console.log("Jump-to page button clicked.");
                table.setPage(parseInt($(this).html()));
                table.update();
            });

            // show/hide the spinny thing
            var spinner = $(this.getID() + ' .spinner')
            spinner.data('tableID', this.getID());
            spinner.hide()
                .ajaxStart(function(){
                    var tableID = $(this).data('tableID');
                    $(this).show();
                    $(tableID + ' #vmlist tr td').hide();
                    $(tableID + ' #vm-wrapper .pagination').hide();
                })
                .ajaxStop(function(){
                    $(this).hide()
                });
        }

        // ------------
        // ajax update
        // ------------
        this.update = function(){

            console.log("Updating table '"+this.getID()+"'...");

            $.get(url, FETCH_ARGS, function(results){
                console.log($(this));
                $results = $(results);
                tbody = $results.children("tbody");
                pagination = $results[2];
                $(tableID + ' #vm-wrapper .pagination')
                        .replaceWith(pagination);
                $(tableID + ' #vmlist tbody').replaceWith(tbody);
            }, "html");
        }
    }

    // -------
    // "main"
    // -------
    $(function(){

        // --[doc ready init]-------------------------------------------------
        {% if cluster %}
            var url = "{% url cluster-virtualmachine-table cluster.slug %}";
        {% else %}
            var url = "{% url virtualmachine-table %}";
        {% endif %}

        var table = new ajaxTable(url, '{{tableID}}');
        table.init();
        //table.update();

        console.log("Table '"+table.getID()+"' initialized with URL '"+url+"'");

        /*
        // --[table sorting]--------------------------------------------------
        $(tableID + ' #vmlist th').live("click", function(){
            $this = $(this)
            field = $this.html();
            order_by = $this.attr("order_by");
            if(field == $this.data('current_order_by') 
                    && $this.hasClass("ascending")){
                $this.addClass("descending")
                        .removeClass("ascending");
                order_by = "-" + order_by;
            } else {
                $(tableID + ' #vmlist th').removeClass('ascending')
                    .removeClass('descending');
                $this.addClass("ascending");
            }
            FETCH_ARGS["page"] = 1;
            FETCH_ARGS["order_by"] = order_by;
            $this.data('current_order_by', field);
            table.update();
        });

        
        */
    });

</script>
{% endblock %}

{% if cluster %}
    <a class="button add" href="{% url instance-create cluster.slug %}">
        Add Virtual Machine
    </a>
{% else %}
    {% if can_create %}
    <a class="button add" href="{% url instance-create %}">
        Add Virtual Machine
    </a>
    {% endif %}
{% endif %}

<div id='{{tableID}}'>
    <div id="vm-wrapper">
        {% include "virtual_machine/inner_table.html" %}
    </div>

    <div class='spinner'>
        <br/>
        Loading...
        <br/>
        <br/>
        <img src='{{ MEDIA_URL }}/images/ajax-loader.gif'>
    </div>
</div>

