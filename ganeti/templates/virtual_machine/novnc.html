<link rel="stylesheet" href="{{SITE_ROOT}}/novnc/plain.css" title="plain">
<style>
    #VNC_status_bar.VNC_status_bar {background-color:#ddd; margin-top:5px;}
    #actions {margin-bottom:30px;}
</style>
<script type="text/javascript">
    // Set include path for noVNC scripts
    var INCLUDE_URI = "{{SITE_ROOT}}/novnc/";

    // Set path for proxy requests
    var PROXY_REQUEST_URI = "{% url instance-vnc-proxy cluster_slug instance.hostname %}";

    // XXX remap document.write to a dom function so that it works after DOM is
    // loaded function will be reset after noVNC scripts are loaded.
    var old = document.write;
    document.write = function(str) {$(document).append(str)};
    document.write('<script type="text/javascript" src="'+INCLUDE_URI+'/vnc.js"><//script>');
    document.write = old;

    // XXX manually call __initialize().  This normally happens onload, but
    // won't work for us since document may have been loaded already
    if (!Websock_native) {WebSocket.__initialize();}

    var rfb;
    var host, port, password; // VNC proxy connection settings
    var connected = false;
    
    $('#connect').click(function() {
        var $this = $(this);
        if($this.hasClass('enabled')) {
            rfb.disconnect();
            connected = false;
        } else {
            connected = true;
            start();
        }
        return false;
    });
    
    $('#encrypt').click(function(){
        var $this = $(this);
        if (!connected) {
            if ($this.hasClass('enabled')){
                $('#encrypt_check').attr('checked',false);
                $this.removeClass('enabled')
            } else {
                $('#encrypt_check').attr('checked',true);
                $this.addClass('enabled')
            }
        }
        return false;
    });
    
    $('#ctrlaltdelete')
        .click(function(){
            if (!$(this).hasClass('disabled')) {
                rfb.sendCtrlAltDel();
            }
            return false;
        });
    
    // users exits the page by following link or closing the tab or sth else
    $(window).bind("unload", function(){
        if (rfb != undefined) {
            rfb.disconnect();
        }
    });
    

    function show_errors() {
        if (host===false || port===false || password===false) {
            connected = false;
            $("#VNC_status_bar")
                .attr("class", "VNC_status_error")
                .html("Probably your proxy is not running or some errors occured. Try again.");
            return false;
        }
        return true;
    }
    
    function updateState(rfb, state, oldstate, msg) {
        var klass;
        switch (state) {
            case 'failed':
            case 'fatal':
                klass = "VNC_status_error";
                break;
            case 'normal':
                klass = "VNC_status_normal";
                break;
            case 'disconnected':
            case 'loaded':
                klass = "VNC_status_normal";
                break;
            case 'password':
                msg = 'Password required';
                klass = "VNC_status_warn";
                break;
            default:
                klass = "VNC_status_warn";
        }
        
        if (state == "normal") {
            connected = true;
            $('#connect')
                .addClass('enabled')
                .html('Disconnect');
            $('#ctrlaltdelete').removeClass('disabled')
        } else {
            connected = false;
            $('#connect')
                .removeClass('enabled')
                .html('Connect');
            $('#ctrlaltdelete').addClass('disabled')
        }
        
        if (msg != undefined) {
            $('#VNC_status_bar')
                .attr("class", klass)
                .html(msg);
        }
    }
    
    function start() {
        $("#vnc_errors").hide();
        $.ajax({
            "async": false,
            "url": PROXY_REQUEST_URI,
            "dataType": "json",
            "success": function(data, s, x){
                host = data[0];
                port = data[1];
                password = data[2];
            }
        });
        if (!show_errors()) return false;
        
        rfb = new RFB({
                            // jQuery doesn't work with that, need to stick
                            // to pure DOM
            'target':       document.getElementById('VNC_canvas'),
            'encrypt':      $('#encrypt_check').attr('checked') ? true : false,
            'true_color':   true,
            'local_cursor': true,
            'shared':       true,
            'updateState':  updateState,
        });
        rfb.connect(host, port, password);
        return false;
    }
</script>

<ul id="actions" class="horizontal">
    <li><a id="encrypt" href="#" class="button encrypt">Encrypt</a></li>
    <li><a id="connect" href="#" class="button connect">Connect</a></li>
    {% ifequal instance.info.status "running" %}
    <li><a class="button shutdown power" href="{% url instance-shutdown cluster_slug instance.hostname %}">Shutdown</a></li>
    <li><a class="button reboot power" href="{% url instance-reboot cluster_slug instance.hostname %}">Reboot</a></li>
    {% else %}
    <li><a class="button startup power" href="{% url instance-startup cluster_slug instance.hostname %}">Start</a></li>
    {% endifequal %}
    <li><a id="ctrlaltdelete" href="#" class="button reboot disabled" title="Send Ctrl-Alt-Delete">Ctrl-Alt-Delete</a></li>
</ul>

<input type="checkbox" id="encrypt_check" />

<div id="VNC_screen">
    <div id="VNC_status_bar" class="VNC_status_bar" style="margin-top: 5px;">
        noVNC client
    </div>
    <canvas id="VNC_canvas" width="812px" height="400px">
        Canvas is not supported in your browser. Please use new versions
        of Chrome or Firefox.
    </canvas>
</div>
